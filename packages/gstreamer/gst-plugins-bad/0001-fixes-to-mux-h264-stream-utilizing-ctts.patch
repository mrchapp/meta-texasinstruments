From 840db30708424195ccbb18be8f100b3c0b0ffb81 Mon Sep 17 00:00:00 2001
From: Rob Clark <rob@ti.com>
Date: Sun, 14 Feb 2010 16:11:25 -0600
Subject: [PATCH] fixes to mux h264 stream utilizing ctts

---
 gst/qtmux/gstqtmux.c |    8 +++++++-
 1 files changed, 7 insertions(+), 1 deletions(-)

diff --git a/gst/qtmux/gstqtmux.c b/gst/qtmux/gstqtmux.c
index c5a818e..e9998db 100644
--- a/gst/qtmux/gstqtmux.c
+++ b/gst/qtmux/gstqtmux.c
@@ -1343,7 +1343,12 @@ gst_qt_mux_add_buffer (GstQTMux * qtmux, GstQTPad * pad, GstBuffer * buf)
   } else {
     nsamples = 1;
     sample_size = GST_BUFFER_SIZE (last_buf);
-    if (pad->have_dts) {
+    /* note: by default offset_end will be 0, but qtdemux (and perhaps
+     * others) sets this to -1.  So treat either as invalid values.
+     */
+    if (pad->have_dts &&
+        (GST_BUFFER_OFFSET_END (last_buf) != -1) &&
+        (GST_BUFFER_OFFSET_END (last_buf) != 0)) {
       gint64 scaled_dts;
       pad->last_dts = GST_BUFFER_OFFSET_END (last_buf);
       if ((gint64) (pad->last_dts) < 0) {
@@ -1894,6 +1899,7 @@ gst_qt_mux_video_sink_set_caps (GstPad * pad, GstCaps * caps)
   } else if (strcmp (mimetype, "video/x-h264") == 0) {
     entry.fourcc = FOURCC_avc1;
     qtpad->is_out_of_order = TRUE;
+    qtpad->have_dts = TRUE;
     if (!codec_data)
       GST_WARNING_OBJECT (qtmux, "no codec_data in h264 caps");
     ext_atom = build_codec_data_extension (FOURCC_avcC, codec_data);
-- 
1.6.1


